# CloudPlayPlus 串码系统详细分析

## 什么是串码系统

在CloudPlayPlus中，"串码系统"是指其身份验证和授权机制，它采用了基于JWT (JSON Web Token) 的实现。这套系统允许用户通过获取和使用临时访问令牌（串码）来访问远程流媒体服务，同时确保通信安全和用户权限管控。

## 系统架构

串码系统的架构包括以下核心组件：

```
+------------------+       +------------------+       +------------------+
|                  |       |                  |       |                  |
|   用户界面       |------>|   认证服务器     |------>|   资源服务器     |
|   (客户端)       |<------|   (颁发串码)     |<------|   (验证串码)     |
|                  |       |                  |       |                  |
+------------------+       +------------------+       +------------------+
                                    |                         ^
                                    v                         |
                            +------------------+              |
                            |                  |              |
                            |   用户数据库     |--------------|  
                            |                  |              |
                            +------------------+              |
                                                             |
                            +------------------+              |
                            |                  |              |
                            |   WebRTC服务    |--------------|  
                            |                  |              |
                            +------------------+              |
```

## 串码技术实现

### 1. JWT令牌结构

CloudPlayPlus的串码采用标准JWT格式，由三部分组成：

- **Header**: 指定加密算法和令牌类型
- **Payload**: 包含用户信息、权限和过期时间
- **Signature**: 用于验证令牌完整性的签名

示例JWT结构：
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user123",
    "name": "张三",
    "admin": true,
    "devices": ["dev1", "dev2"],
    "exp": 1625097600
  },
  "signature": "..."
}
```

### 2. 双令牌机制

CloudPlayPlus实现了双令牌机制，提高安全性：

```dart
// 从login_service.dart中可以看出
static Future<bool> loginWithCredentials(String username, String password) async {
  // ...
  if (response.statusCode == 200) {
    // 解析响应获取access_token和refresh_token
    final responseBody = jsonDecode(response.body);
    
    // 存储令牌
    if (DevelopSettings.useSecureStorage) {
      await SecureStorageManager.setString('access_token', responseBody['access']);
      await SecureStorageManager.setString('refresh_token', responseBody['refresh']);
    } else {
      await SharedPreferenceManager.setString('access_token', responseBody['access']);
      await SharedPreferenceManager.setString('refresh_token', responseBody['refresh']);
    }
    // ...
  }
}
```

这种机制包括：
- **访问令牌(access_token)**: 短期有效，用于访问资源
- **刷新令牌(refresh_token)**: 长期有效，用于获取新的访问令牌

### 3. 令牌验证流程

```dart
static bool isTokenValid(String token) {
  try {
    final parts = token.split('.');
    if (parts.length != 3) {
      return false;
    }

    // 解码JWT负载部分
    final payload = parts[1];
    final normalizedPayload = base64Url.normalize(payload);
    final resp = utf8.decode(base64Url.decode(normalizedPayload));
    final payloadMap = json.decode(resp) as Map<String, dynamic>;

    // 检查令牌是否过期
    if (payloadMap.containsKey('exp')) {
      final now = DateTime.now().millisecondsSinceEpoch;
      final expiry = (payloadMap['exp'] as int) * 1000; // 秒转毫秒

      if (expiry > now) {
        // 令牌仍有效
        return true;
      }
    }
    return false;
  } catch (e) {
    return false;
  }
}
```

### 4. 令牌存储安全

CloudPlayPlus根据设备安全级别，提供两种存储方式：

- **安全存储(SecureStorage)**: 在高安全性要求场景使用
  ```dart
  await SecureStorageManager.setString('access_token', responseBody['access']);
  ```

- **共享首选项(SharedPreferences)**: 在普通场景使用
  ```dart
  await SharedPreferenceManager.setString('access_token', responseBody['access']);
  ```

## 串码系统与WebRTC集成

### 1. 信令通道授权

CloudPlayPlus使用串码对WebSocket信令通道进行身份验证：

```dart
// 建立WebSocket连接时附加令牌
_wsChannel = WebSocketChannel.connect(Uri.parse("$serverAddress?token=$accessToken"));
```

服务器端会验证令牌有效性，确保只有授权用户才能建立信令连接。

### 2. TURN服务器凭证

串码系统与TURN服务器集成，确保媒体中继安全：

```dart
// TURN服务器配置中可以使用基于用户身份的动态凭证
_config = {
  'iceServers': [
    {
      'urls': 'turn:47.100.84.139:3478',
      'username': 'cloudplayplus', // 可动态替换为用户特定凭证
      'credential': 'zhuhaichao'
    }
  ]
};
```

在更高级的实现中，可以从JWT令牌中提取用户信息，生成特定于用户的TURN凭证。

### 3. 会话权限控制

串码中包含的权限信息用于控制用户可以访问的设备和功能：

```dart
// 假设JWT payload中包含devices字段
// {
//   "sub": "user123",
//   "devices": ["dev1", "dev2"],
//   "exp": 1625097600
// }

// 检查用户是否有权访问特定设备
boolean hasAccessToDevice(String deviceId, String token) {
  Map<String, dynamic> payload = decodeJwtPayload(token);
  List<String> allowedDevices = payload['devices'];
  return allowedDevices.contains(deviceId);
}
```

## 安全考量

### 1. 防止令牌劫持

CloudPlayPlus通过以下措施防止令牌劫持：

- 使用HTTPS进行API通信
- 使用安全存储机制
- 令牌短期有效性
- 实现刷新令牌轮换

### 2. 防止重放攻击

- 令牌包含过期时间(exp)
- 可选实现令牌唯一标识符(jti)

### 3. 权限粒度控制

令牌payload可包含细粒度权限：

```json
{
  "sub": "user123",
  "permissions": [
    "stream:read",
    "device:control",
    "settings:write"
  ],
  "device_groups": ["home", "office"],
  "exp": 1625097600
}
```

## 最佳实践

1. **令牌生命周期管理**：访问令牌短期有效（如15分钟），刷新令牌长期有效（如7天）
2. **安全存储**：在支持的设备上使用安全加密存储
3. **自动刷新**：在令牌过期前自动刷新
4. **错误处理**：实现优雅的身份验证失败处理流程
5. **令牌撤销**：实现令牌黑名单机制

## 总结

CloudPlayPlus的串码系统是一个基于JWT的全面身份验证和授权解决方案，它与WebRTC技术紧密集成，确保了远程流媒体连接的安全性和可靠性。通过实现双令牌机制、安全存储和细粒度权限控制，系统在提供便捷用户体验的同时保持了高安全标准。