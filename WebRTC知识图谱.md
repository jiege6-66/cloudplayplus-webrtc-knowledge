# CloudPlayPlus WebRTC 知识图谱

## 核心概念图

```
+---------------------+        +---------------------+        +---------------------+
|                     |        |                     |        |                     |
|    远程设备层       |<------>|    信令层          |<------>|    客户端应用层     |
|                     |        |                     |        |                     |
+---------------------+        +---------------------+        +---------------------+
           |                             |                             |
           v                             v                             v
+---------------------+        +---------------------+        +---------------------+
|                     |        |                     |        |                     |
|    媒体流处理       |<------>|    网络传输        |<------>|    用户界面        |
|                     |        |                     |        |                     |
+---------------------+        +---------------------+        +---------------------+
           |                             |                             |
           |                             v                             |
           |                   +---------------------+                 |
           |                   |                     |                 |
           +------------------>|    安全与授权      |<----------------+
                               |    (串码系统)      |
                               |                     |
                               +---------------------+
```

## 组件关系

### 1. 设备层级关系

- **远程设备** → **流媒体服务** → **客户端设备**

### 2. 信令流程

```
+----------------+     (1)创建连接请求      +----------------+
|                |-------------------------->|                |
|   客户端 A     |                          |   客户端 B     |
|                |<--------------------------|                |
+----------------+     (2)接受连接          +----------------+
        |                                           |
        | (3)创建SDP Offer                         |
        v                                           |
+----------------+     (4)发送SDP Offer     +----------------+
|                |-------------------------->|                |
|   信令服务器   |                          |   信令服务器   |
|                |<--------------------------|                |
+----------------+     (5)发送SDP Answer    +----------------+
        |                                           |
        | (6)收集ICE候选者                         | (7)收集ICE候选者
        v                                           v
+----------------+     (8)交换ICE候选者    +----------------+
|                |<------------------------->|                |
|   NAT/防火墙   |                          |   NAT/防火墙   |
|                |                          |                |
+----------------+                          +----------------+
        |                                           |
        | (9)建立P2P连接                           |
        +------------------------------------------+
```

### 3. 授权与安全机制

```
用户登录 → 获取JWT令牌(串码) → 使用令牌连接信令服务器 → 身份验证通过 → 建立WebRTC连接
```

### 4. 媒体流与会话管理

```
+-------------------+     +-------------------+     +-------------------+
|                   |     |                   |     |                   |
|  设备1 媒体流     |     |  设备2 媒体流     |     |  设备3 媒体流     |
|                   |     |                   |     |                   |
+--------+----------+     +--------+----------+     +--------+----------+
         |                         |                         |
         v                         v                         v
+-----------------------------------------------------------+
|                                                           |
|                 StreamingManager                          |
|                                                           |
+-----------------------------------------------------------+
                           |
                           v
+-----------------------------------------------------------+
|                                                           |
|                 当前选中设备流                           |
|                                                           |
+-----------------------------------------------------------+
                           |
                           v
+-----------------------------------------------------------+
|                                                           |
|                 全局视频/音频渲染器                      |
|                                                           |
+-----------------------------------------------------------+
```

## 关键技术知识点

### WebRTC 核心API

- **MediaStream API**: 访问用户媒体设备
- **RTCPeerConnection API**: 建立点对点连接
- **RTCDataChannel API**: 传输任意数据

### NAT穿透技术

- **ICE (Interactive Connectivity Establishment)**: 连接建立协议
- **STUN (Session Traversal Utilities for NAT)**: 发现公网IP地址
- **TURN (Traversal Using Relays around NAT)**: 作为媒体中继服务器

### 信令方案

- **WebSocket**: 低延迟双向通信
- **SDP (Session Description Protocol)**: 媒体会话描述
- **ICE Candidate**: 潜在连接端点信息

### 安全机制

- **DTLS (Datagram Transport Layer Security)**: 加密媒体传输
- **SRTP (Secure Real-time Transport Protocol)**: 保护音视频数据
- **JWT (JSON Web Token)**: 身份验证和授权

### Flutter集成

- **flutter_webrtc**: Flutter的WebRTC插件
- **Flutter Platform Channels**: 与原生代码通信
- **State Management**: 管理WebRTC连接状态

## 开发者常见挑战

1. 网络穿透与连接可靠性
2. 媒体流质量与延迟控制
3. 多设备会话管理
4. 安全验证与加密
5. 跨平台兼容性

## 关键代码架构

- **`webrtc_service.dart`**: WebRTC核心服务
- **`streaming_manager.dart`**: 流管理器
- **`login_service.dart`**: 身份验证服务
- **`settings_screen.dart`**: 配置界面
- **`video_view.dart`**: 视频显示组件
